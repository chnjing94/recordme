# é¢è¯•é¢˜

### Reactor æ¨¡å‹

ä»€ä¹ˆæ˜¯ReactoråŠä¸‰ç§ç‰ˆæœ¬ï¼Ÿ

Reactor çš„çº¿ç¨‹æ¨¡å‹æœ‰ä¸‰ç§:

- å•çº¿ç¨‹æ¨¡å‹

  ![](./pic/reactorå•çº¿ç¨‹.png)

  ```java
  EventLoopGroup bossGroup = new NioEventLoopGroup(1);
  ServerBootstrap b = new ServerBootstrap();
  b.group(bossGroup)
   .channel(NioServerSocketChannel.class)
   ...
  ```

- å¤šçº¿ç¨‹æ¨¡å‹

  ![](./pic/02.png)

  ```java
  EventLoopGroup bossGroup = new NioEventLoopGroup();
  EventLoopGroup workerGroup = new NioEventLoopGroup();
  ServerBootstrap b = new ServerBootstrap();
  b.group(bossGroup, workerGroup)
   .channel(NioServerSocketChannel.class)
   ...
  ```

  

- ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ï¼ˆNettyä¸æ”¯æŒï¼‰

  ![](./pic/reactorä¸»ä».png)

  

[ã€ŠNetty æºç åˆ†æä¹‹ ä¸‰ æˆ‘å°±æ˜¯å¤§åé¼é¼çš„ EventLoop(ä¸€)ã€‹](https://segmentfault.com/a/1190000007403873)



![](./pic/01.png)

**Nettyé‡‡ç”¨å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹**

![](./pic/03.png)

1. mainReactor è´Ÿè´£ç›‘å¬ ServerSocketChannel ï¼Œç”¨æ¥å¤„ç†å®¢æˆ·ç«¯æ–°è¿æ¥çš„å»ºç«‹ï¼Œå¹¶å°†å»ºç«‹çš„å®¢æˆ·ç«¯çš„ SocketChannel æŒ‡å®šæ³¨å†Œç»™ subReactor ã€‚
2. subReactor ç»´æŠ¤è‡ªå·±çš„ Selector ï¼ŒåŸºäº mainReactor å»ºç«‹çš„å®¢æˆ·ç«¯çš„ SocketChannel å¤šè·¯åˆ†ç¦» IO è¯»å†™äº‹ä»¶ï¼Œè¯»å†™ç½‘ç»œæ•°æ®ã€‚å¯¹äºä¸šåŠ¡å¤„ç†çš„åŠŸèƒ½ï¼Œå¦å¤–æ‰”ç»™ worker çº¿ç¨‹æ± æ¥å®Œæˆã€‚

### TCP ç²˜åŒ… / æ‹†åŒ…çš„åŸå› ï¼Ÿåº”è¯¥è¿™ä¹ˆè§£å†³ï¼Ÿ

- **æ¦‚å¿µ**

  **UDPæ— ç²˜åŒ…é—®é¢˜**

  UDPä¸å­˜åœ¨ç²˜åŒ…é—®é¢˜ï¼Œæ˜¯ç”±äºUDPå‘é€çš„æ—¶å€™ï¼Œæ²¡æœ‰ç»è¿‡Negalç®—æ³•ä¼˜åŒ–ï¼Œä¸ä¼šå°†å¤šä¸ªå°åŒ…åˆå¹¶ä¸€æ¬¡å‘é€å‡ºå»ã€‚å¦å¤–ï¼ŒUDPåè®®æœ‰æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œï¼Œæ¥æ”¶ç«¯é‡‡ç”¨äº†é“¾å¼ç»“æ„æ¥è®°å½•æ¯ä¸€ä¸ªåˆ°è¾¾çš„UDPåŒ…ï¼Œè¿™æ ·æ¥æ”¶ç«¯åº”ç”¨ç¨‹åºä¸€æ¬¡recvåªèƒ½ä»socketæ¥æ”¶ç¼“å†²åŒºä¸­è¯»å‡ºä¸€ä¸ªæ•°æ®åŒ…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ç«¯sendäº†å‡ æ¬¡ï¼Œæ¥æ”¶ç«¯å¿…é¡»recvå‡ æ¬¡ï¼ˆæ— è®ºrecvæ—¶æŒ‡å®šäº†å¤šå¤§çš„ç¼“å†²åŒºï¼‰ã€‚

  

  TCPæ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œã€‚UDPæ˜¯é¢å‘æ¶ˆæ¯çš„ï¼Œæœ‰æ¶ˆæ¯è¾¹ç•Œã€‚

  TCP æ˜¯ä»¥æµçš„æ–¹å¼æ¥å¤„ç†æ•°æ®ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ç²˜åŒ… / æ‹†åŒ…ã€‚

  - æ‹†åŒ…ï¼šä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢« TCP æ‹†åˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ã€‚
  - ç²˜åŒ…ï¼šä¹Ÿå¯èƒ½æŠŠå°çš„å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ã€‚

- **åŸå› **

  - åº”ç”¨ç¨‹åºå†™å…¥çš„å­—èŠ‚å¤§å°å¤§äºå¥—æ¥å­—å‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œä¼šå‘ç”Ÿ**æ‹†åŒ…**ç°è±¡ã€‚
  - å‘é€çš„æ•°æ®å¤§äºåè®®çš„MTU(Max Transmission Unitï¼Œæœ€å¤§ä¼ è¾“å•å…ƒ)æ—¶ï¼Œ
    - ä¼ è¾“å±‚ï¼Œå¾…å‘é€æ•°æ®å¤§äº MSSï¼ˆæœ€å¤§æŠ¥æ–‡é•¿åº¦ï¼‰ï¼ŒTCP åœ¨ä¼ è¾“å‰å°†è¿›è¡Œ**æ‹†åŒ…**ã€‚
    - æ•°æ®é“¾è·¯å±‚ï¼Œæ•°æ®ä»¥å¤ªç½‘å¸§çš„ payloadï¼ˆå‡€è·ï¼‰å¤§äº MTUï¼ˆé»˜è®¤ä¸º 1500 å­—èŠ‚ï¼‰è¿›è¡Œ**æ‹†åŒ…**ã€‚
  - åº”ç”¨ç¨‹åºå†™å…¥æ•°æ®å°äºå¥—æ¥å­—ç¼“å†²åŒºå¤§å°ï¼Œç½‘å¡å°†åº”ç”¨å¤šæ¬¡å†™å…¥çš„æ•°æ®å‘é€åˆ°ç½‘ç»œä¸Šï¼Œè¿™å°†ä¼šå‘ç”Ÿ**ç²˜åŒ…**ç°è±¡ã€‚æ¥æ”¶æ•°æ®ç«¯çš„åº”ç”¨å±‚æ²¡æœ‰åŠæ—¶è¯»å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå°†å‘ç”Ÿ**ç²˜åŒ…**ã€‚

- **è§£å†³**

  åœ¨ Netty ä¸­ï¼Œæä¾›äº†å¤šä¸ª Decoder è§£æç±»ï¼Œå¦‚ä¸‹ï¼š

  - â‘  FixedLengthFrameDecoder ï¼ŒåŸºäº**å›ºå®šé•¿åº¦**æ¶ˆæ¯è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
  - â‘¡ LengthFieldBasedFrameDecoder ï¼ŒåŸºäº**æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦**è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
  - â‘¢ LineBasedFrameDecoder ï¼ŒåŸºäº**æ¢è¡Œ**æ¥è¿›è¡Œæ¶ˆæ¯ç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚
  - â‘£ DelimiterBasedFrameDecoder ï¼ŒåŸºäº**æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼**è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚

  å®é™…ä¸Šï¼Œä¸Šè¿°å››ä¸ª FrameDecoder å®ç°å¯ä»¥è¿›è¡Œè§„æ•´ï¼š

  - â‘  æ˜¯ â‘¡ çš„ç‰¹ä¾‹ï¼Œ**å›ºå®šé•¿åº¦**æ˜¯**æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦**çš„ä¸€ç§å½¢å¼ã€‚
  - â‘¢ æ˜¯ â‘£ çš„ç‰¹ä¾‹ï¼Œ**æ¢è¡Œ**æ˜¯äº**æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼**çš„ä¸€ç§å½¢å¼ã€‚

### äº†è§£å“ªå‡ ç§åºåˆ—åŒ–åè®®ï¼Ÿ

1. ã€é‡ç‚¹ã€‘Java é»˜è®¤æä¾›çš„åºåˆ—åŒ–
   - æ— æ³•è·¨è¯­è¨€ï¼›åºåˆ—åŒ–åçš„å­—èŠ‚å¤§å°å¤ªå¤§ï¼›åºåˆ—åŒ–çš„æ€§èƒ½å·®ã€‚
2. ã€é‡ç‚¹ã€‘XML ã€‚
   - ä¼˜ç‚¹ï¼šäººæœºå¯è¯»æ€§å¥½ï¼Œå¯æŒ‡å®šå…ƒç´ æˆ–ç‰¹æ€§çš„åç§°ã€‚
   - ç¼ºç‚¹ï¼šåºåˆ—åŒ–æ•°æ®åªåŒ…å«æ•°æ®æœ¬èº«ä»¥åŠç±»çš„ç»“æ„ï¼Œä¸åŒ…æ‹¬ç±»å‹æ ‡è¯†å’Œç¨‹åºé›†ä¿¡æ¯ï¼›åªèƒ½åºåˆ—åŒ–å…¬å…±å±æ€§å’Œå­—æ®µï¼›ä¸èƒ½åºåˆ—åŒ–æ–¹æ³•ï¼›æ–‡ä»¶åºå¤§ï¼Œæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œä¼ è¾“å å¸¦å®½ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šå½“åšé…ç½®æ–‡ä»¶å­˜å‚¨æ•°æ®ï¼Œå®æ—¶æ•°æ®è½¬æ¢ã€‚
3. ã€é‡ç‚¹ã€‘JSON ï¼Œæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚
   - ä¼˜ç‚¹ï¼šå…¼å®¹æ€§é«˜ã€æ•°æ®æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œæ˜“äºè¯»å†™ã€åºåˆ—åŒ–åæ•°æ®è¾ƒå°ï¼Œå¯æ‰©å±•æ€§å¥½ï¼Œå…¼å®¹æ€§å¥½ã€‚ä¸ XML ç›¸æ¯”ï¼Œå…¶åè®®æ¯”è¾ƒç®€å•ï¼Œè§£æé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚
   - ç¼ºç‚¹ï¼šæ•°æ®çš„æè¿°æ€§æ¯” XML å·®ã€ä¸é€‚åˆæ€§èƒ½è¦æ±‚ä¸º ms çº§åˆ«çš„æƒ…å†µã€é¢å¤–ç©ºé—´å¼€é”€æ¯”è¾ƒå¤§ã€‚
   - é€‚ç”¨åœºæ™¯ï¼ˆå¯æ›¿ä»£ XML ï¼‰ï¼šè·¨é˜²ç«å¢™è®¿é—®ã€å¯è°ƒå¼æ€§è¦æ±‚é«˜ã€åŸºäºRestful API è¯·æ±‚ã€ä¼ è¾“æ•°æ®é‡ç›¸å¯¹å°ï¼Œå®æ—¶æ€§è¦æ±‚ç›¸å¯¹ä½ï¼ˆä¾‹å¦‚ç§’çº§åˆ«ï¼‰çš„æœåŠ¡ã€‚
4. ã€äº†è§£ã€‘Thrift ï¼Œä¸ä»…æ˜¯åºåˆ—åŒ–åè®®ï¼Œè¿˜æ˜¯ä¸€ä¸ª RPC æ¡†æ¶ã€‚
   - ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åçš„ä½“ç§¯å°, é€Ÿåº¦å¿«ã€æ”¯æŒå¤šç§è¯­è¨€å’Œä¸°å¯Œçš„æ•°æ®ç±»å‹ã€å¯¹äºæ•°æ®å­—æ®µçš„å¢åˆ å…·æœ‰è¾ƒå¼ºçš„å…¼å®¹æ€§ã€æ”¯æŒäºŒè¿›åˆ¶å‹ç¼©ç¼–ç ã€‚
   - ç¼ºç‚¹ï¼šä½¿ç”¨è€…è¾ƒå°‘ã€è·¨é˜²ç«å¢™è®¿é—®æ—¶ï¼Œä¸å®‰å…¨ã€ä¸å…·æœ‰å¯è¯»æ€§ï¼Œè°ƒè¯•ä»£ç æ—¶ç›¸å¯¹å›°éš¾ã€ä¸èƒ½ä¸å…¶ä»–ä¼ è¾“å±‚åè®®å…±åŒä½¿ç”¨ï¼ˆä¾‹å¦‚ HTTPï¼‰ã€æ— æ³•æ”¯æŒå‘æŒä¹…å±‚ç›´æ¥è¯»å†™æ•°æ®ï¼Œå³ä¸é€‚åˆåšæ•°æ®æŒä¹…åŒ–åºåˆ—åŒ–åè®®ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„ RPC è§£å†³æ–¹æ¡ˆã€‚
5. ã€äº†è§£ã€‘Avro ï¼ŒHadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œè§£å†³äº†JSONçš„å†—é•¿å’Œæ²¡æœ‰IDLçš„é—®é¢˜ã€‚
   - ä¼˜ç‚¹ï¼šæ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹ã€ç®€å•çš„åŠ¨æ€è¯­è¨€ç»“åˆåŠŸèƒ½ã€å…·æœ‰è‡ªæˆ‘æè¿°å±æ€§ã€æé«˜äº†æ•°æ®è§£æé€Ÿåº¦ã€å¿«é€Ÿå¯å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®å½¢å¼ã€å¯ä»¥å®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ RPCã€æ”¯æŒè·¨ç¼–ç¨‹è¯­è¨€å®ç°ã€‚
   - ç¼ºç‚¹ï¼šå¯¹äºä¹ æƒ¯äºé™æ€ç±»å‹è¯­è¨€çš„ç”¨æˆ·ä¸ç›´è§‚ã€‚
   - é€‚ç”¨åœºæ™¯ï¼šåœ¨ Hadoop ä¸­åš Hiveã€Pig å’Œ MapReduce çš„æŒä¹…åŒ–æ•°æ®æ ¼å¼ã€‚
6. ã€é‡ç‚¹ã€‘Protobuf ï¼Œå°†æ•°æ®ç»“æ„ä»¥`.proto` æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·å¯ä»¥ç”Ÿæˆå¯¹åº”æ•°æ®ç»“æ„çš„ POJO å¯¹è±¡å’Œ Protobuf ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§ã€‚
   - ä¼˜ç‚¹ï¼šåºåˆ—åŒ–åç æµå°ï¼Œæ€§èƒ½é«˜ã€ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼ˆXML JSONç­‰ï¼‰ã€é€šè¿‡æ ‡è¯†å­—æ®µçš„é¡ºåºï¼Œå¯ä»¥å®ç°åè®®çš„å‰å‘å…¼å®¹ã€ç»“æ„åŒ–çš„æ–‡æ¡£æ›´å®¹æ˜“ç®¡ç†å’Œç»´æŠ¤ã€‚
   - ç¼ºç‚¹ï¼šéœ€è¦ä¾èµ–äºå·¥å…·ç”Ÿæˆä»£ç ã€æ”¯æŒçš„è¯­è¨€ç›¸å¯¹è¾ƒå°‘ï¼Œå®˜æ–¹åªæ”¯æŒJava ã€C++ã€pythonã€‚
   - é€‚ç”¨åœºæ™¯ï¼šå¯¹æ€§èƒ½è¦æ±‚é«˜çš„ RPC è°ƒç”¨ã€å…·æœ‰è‰¯å¥½çš„è·¨é˜²ç«å¢™çš„è®¿é—®å±æ€§ã€é€‚åˆåº”ç”¨å±‚å¯¹è±¡çš„æŒä¹…åŒ–ã€‚
7. å…¶å®ƒ
   - ã€é‡ç‚¹ã€‘Protostuff ï¼ŒåŸºäº Protobuf åè®®ï¼Œä½†ä¸éœ€è¦é…ç½®proto æ–‡ä»¶ï¼Œç›´æ¥å¯¼åŒ…å³å¯ã€‚
     - ç›®å‰ï¼Œå¾®åš RPC æ¡†æ¶ Motan åœ¨ä½¿ç”¨å®ƒã€‚
   - ã€äº†è§£ã€‘Jboss Marshaling ï¼Œå¯ä»¥ç›´æ¥åºåˆ—åŒ– Java ç±»ï¼Œ æ— é¡»å® `java.io.Serializable` æ¥å£ã€‚
   - ã€äº†è§£ã€‘Message Pack ï¼Œä¸€ä¸ªé«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–æ ¼å¼ã€‚
   - ã€é‡ç‚¹ã€‘Hessianï¼Œé‡‡ç”¨äºŒè¿›åˆ¶åè®®çš„è½»é‡çº§ remoting on http æœåŠ¡ã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„**é»˜è®¤**åºåˆ—åŒ–åè®®ã€‚
   - ã€é‡è¦ã€‘kryo ï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾å½¢åºåˆ—åŒ–æ¡†æ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„å¯é€‰åºåˆ—åŒ–åè®®ã€‚
   - ã€é‡è¦ã€‘FST ï¼Œfast-serialization æ˜¯é‡æ–°å®ç°çš„ Java å¿«é€Ÿå¯¹è±¡åºåˆ—åŒ–çš„å¼€å‘åŒ…ã€‚åºåˆ—åŒ–é€Ÿåº¦æ›´å¿«ï¼ˆ2-10å€ï¼‰ã€ä½“ç§¯æ›´å°ï¼Œè€Œä¸”å…¼å®¹ JDK åŸç”Ÿçš„åºåˆ—åŒ–ã€‚è¦æ±‚ JDK 1.7 æ”¯æŒã€‚
     - ç›®å‰ï¼Œé˜¿é‡Œ RPC æ¡†æ¶ Dubbo çš„å¯é€‰åºåˆ—åŒ–åè®®ã€‚

### Keepaliveä¸Idleç›‘æµ‹

**ä¸ºä»€ä¹ˆéœ€è¦keepalive?**

åŠæ—¶é‡Šæ”¾åæ‰çš„ï¼Œç©ºé—²çš„è¿æ¥ã€‚



**TCP keepaliveæ€ä¹ˆè®¾è®¡çš„ï¼Ÿ**

æœ‰ä¸‰ä¸ªç³»ç»Ÿå‚æ•°æ§åˆ¶tcp keepaliveï¼Œåˆ†åˆ«æ˜¯keep aliveæ—¶é•¿ï¼Œå‘é€keep aliveé—´éš”æ—¶é•¿ï¼Œå‘é€æ¬¡æ•°ã€‚



**ä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨å±‚keepalive?**

- åè®®åˆ†å±‚ï¼Œå„ä¸ªå±‚å…³æ³¨ç‚¹ä¸åŒ
- TCPå±‚keepalive é»˜è®¤å…³é—­ï¼Œæ—¶é—´å¤ªé•¿
- ä¿®æ”¹TCPå±‚keepaliveå‚æ•°ä¼šå½±å“åŒä¸€å°æœåŠ¡å™¨åˆ«çš„åº”ç”¨



**å¦‚ä½•åœ¨Nettyä¸­å¼€åŒºTCP keepaliveå’ŒIdleæ£€æµ‹ï¼Ÿ**

å¼€å¯TCP keepalive: .option()

Idleæ£€æµ‹: æ·»åŠ Idleæ£€æµ‹handlerï¼Œæ£€æµ‹åˆ°idleè§¦å‘äº‹ä»¶ã€‚æ·»åŠ è‡ªå®šä¹‰handleræ¥å“åº”idleäº‹ä»¶ã€‚



**ä»€ä¹ˆæ˜¯ Netty ç©ºé—²æ£€æµ‹ï¼Ÿ**

åœ¨ Netty ä¸­ï¼Œæä¾›äº† IdleStateHandler ç±»ï¼Œæ­£å¦‚å…¶åï¼Œç©ºé—²çŠ¶æ€å¤„ç†å™¨ï¼Œç”¨äºæ£€æµ‹è¿æ¥çš„è¯»å†™æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä¼šè§¦å‘ IdleStateEvent ã€‚

IdleStateHandler ç›®å‰æä¾›ä¸‰ç§ç±»å‹çš„å¿ƒè·³æ£€æµ‹ï¼Œé€šè¿‡æ„é€ æ–¹æ³•æ¥è®¾ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// IdleStateHandler.java

public IdleStateHandler(
        int readerIdleTimeSeconds,
        int writerIdleTimeSeconds,
        int allIdleTimeSeconds) {
    this(readerIdleTimeSeconds, writerIdleTimeSeconds, allIdleTimeSeconds,
         TimeUnit.SECONDS);
}
```

- `readerIdleTimeSeconds` å‚æ•°ï¼šä¸ºè¯»è¶…æ—¶æ—¶é—´ï¼Œå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…æœªæ¥å—åˆ°è¢«æµ‹è¯•ç«¯æ¶ˆæ¯ã€‚
- `writerIdleTimeSeconds` å‚æ•°ï¼šä¸ºå†™è¶…æ—¶æ—¶é—´ï¼Œå³æµ‹è¯•ç«¯ä¸€å®šæ—¶é—´å†…å‘è¢«æµ‹è¯•ç«¯å‘é€æ¶ˆæ¯ã€‚
- `allIdleTimeSeconds` å‚æ•°ï¼šä¸ºè¯»æˆ–å†™è¶…æ—¶æ—¶é—´ã€‚

------

å¦å¤–ï¼Œæˆ‘ä»¬ä¼šåœ¨ç½‘ç»œä¸Šçœ‹åˆ°ç±»ä¼¼ã€ŠIdleStateHandler å¿ƒè·³æœºåˆ¶ã€‹è¿™æ ·æ ‡é¢˜çš„æ–‡ç« ï¼Œå®é™…ä¸Šç©ºé—²æ£€æµ‹å’Œå¿ƒè·³æœºåˆ¶æ˜¯**ä¸¤ä»¶äº‹**ã€‚

- åªæ˜¯è¯´ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ IdleStateHandler çš„ç›®çš„ï¼Œå°±æ˜¯æ£€æµ‹åˆ°è¿æ¥å¤„äºç©ºé—²ï¼Œé€šè¿‡å¿ƒè·³åˆ¤æ–­å…¶æ˜¯å¦è¿˜æ˜¯**æœ‰æ•ˆçš„è¿æ¥**ã€‚
- è™½ç„¶è¯´ï¼ŒTCP åè®®å±‚æä¾›äº† Keeplive æœºåˆ¶ï¼Œä½†æ˜¯è¯¥æœºåˆ¶é»˜è®¤çš„å¿ƒè·³æ—¶é—´æ˜¯ 2 å°æ—¶ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿå®ç°ä¸å¤Ÿçµæ´»ã€‚å› è€Œï¼Œæˆ‘ä»¬æ‰åœ¨åº”ç”¨å±‚ä¸Šï¼Œè‡ªå·±å®ç°å¿ƒè·³æœºåˆ¶ã€‚



**Netty å¦‚ä½•å®ç°é‡è¿ï¼Ÿ**

- å®¢æˆ·ç«¯ï¼Œé€šè¿‡ IdleStateHandler å®ç°å®šæ—¶æ£€æµ‹æ˜¯å¦ç©ºé—²ï¼Œä¾‹å¦‚è¯´ 15 ç§’ã€‚
  - å¦‚æœç©ºé—²ï¼Œåˆ™å‘æœåŠ¡ç«¯å‘èµ·å¿ƒè·³ã€‚
  - æ£€æµ‹åˆ°channelè¢«å…³é—­ï¼Œåˆ™é‡æ–°å‘èµ·è¿æ¥ã€‚
- æœåŠ¡ç«¯ï¼Œé€šè¿‡ IdleStateHandler å®ç°å®šæ—¶æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦ç©ºé—²ï¼Œä¾‹å¦‚è¯´ 90 ç§’ã€‚
  - å¦‚æœæ£€æµ‹åˆ°ç©ºé—²ï¼Œåˆ™å…³é—­å®¢æˆ·ç«¯ã€‚



### Nettyå†…å­˜ç›¸å…³

**Netty çš„é›¶æ‹·è´å®ç°ï¼Ÿ**

Netty çš„é›¶æ‹·è´å®ç°ï¼Œæ˜¯ä½“ç°åœ¨å¤šæ–¹é¢çš„ï¼Œä¸»è¦å¦‚ä¸‹ï¼š

1. ã€é‡ç‚¹ã€‘Netty çš„æ¥æ”¶å’Œå‘é€ ByteBuffer é‡‡ç”¨å †å¤–ç›´æ¥å†…å­˜Direct Bufferã€‚

   - ä½¿ç”¨å †å¤–ç›´æ¥å†…å­˜è¿›è¡Œ Socket è¯»å†™ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ï¼›ä½¿ç”¨å †å†…å†…å­˜ä¼šå¤šäº†ä¸€æ¬¡å†…å­˜æ‹·è´ï¼ŒJVM ä¼šå°†å †å†…å­˜ Buffer æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­ï¼Œç„¶åæ‰å†™å…¥ Socket ä¸­ã€‚
   - Netty åˆ›å»ºçš„ ByteBuffer ç±»å‹ï¼Œç”± ChannelConfig é…ç½®ã€‚è€Œ ChannelConfig é…ç½®çš„ ByteBufAllocator é»˜è®¤åˆ›å»º Direct Buffer ç±»å‹ã€‚

2. CompositeByteBufç±»ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå° Buffer åˆå¹¶æˆä¸€ä¸ªå¤§çš„ Buffer ã€‚

   - `#addComponents(...)` æ–¹æ³•ï¼Œå¯å°† header ä¸ body åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBuf ã€‚è¿™ä¸¤ä¸ª ByteBuf åœ¨CompositeByteBuf å†…éƒ¨éƒ½æ˜¯å•ç‹¬å­˜åœ¨çš„ï¼Œå³ CompositeByteBuf åªæ˜¯é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªæ•´ä½“ã€‚

3. é€šè¿‡FileRegionåŒ…è£…çš„ FileChannel ã€‚

   - `#tranferTo(...)` æ–¹æ³•ï¼Œå®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ Channel ï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ write æ–¹å¼ï¼Œå¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜ã€‚

4. é€šè¿‡ **wrap** æ–¹æ³•, æˆ‘ä»¬å¯ä»¥å°† `byte[]` æ•°ç»„ã€ByteBufã€ByteBuffer ç­‰åŒ…è£…æˆä¸€ä¸ª Netty ByteBuf å¯¹è±¡, è¿›è€Œé¿å…äº†æ‹·è´æ“ä½œã€‚

   

**Netty è‡ªå·±å®ç°çš„ ByteBuf æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ**

- A01. å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„**ç¼“å†²åŒºç±»å‹**æ‰©å±•
- A02. **é›¶æ‹·è´**
- A03. å®¹é‡å¯ä»¥**æŒ‰éœ€å¢é•¿**
- A04. åœ¨è¯»å’Œå†™è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨ `#flip()` æ–¹æ³•
- A05. è¯»å’Œå†™ä½¿ç”¨äº†**ä¸åŒçš„ç´¢å¼•**
- A06. æ”¯æŒæ–¹æ³•çš„**é“¾å¼**è°ƒç”¨
- A07. æ”¯æŒå¼•ç”¨è®¡æ•°
- A08. æ”¯æŒ**æ± åŒ–**
- A09. æ”¯æŒDirect ByteBuf



**Netty ä¸ºä»€ä¹ˆè¦å®ç°å†…å­˜ç®¡ç†ï¼Ÿ**

- **è€è‰¿è‰¿çš„ç†è§£**

åœ¨ Netty ä¸­ï¼ŒIO è¯»å†™å¿…å®šæ˜¯éå¸¸é¢‘ç¹çš„æ“ä½œï¼Œè€Œè€ƒè™‘åˆ°æ›´é«˜æ•ˆçš„ç½‘ç»œä¼ è¾“æ€§èƒ½ï¼ŒDirect ByteBuffer å¿…ç„¶æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ã€‚ä½†æ˜¯ Direct ByteBuffer çš„ç”³è¯·å’Œé‡Šæ”¾æ˜¯é«˜æˆæœ¬çš„æ“ä½œï¼Œé‚£ä¹ˆè¿›è¡Œ**æ± åŒ–**ç®¡ç†ï¼Œå¤šæ¬¡é‡ç”¨æ˜¯æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹å¼ã€‚ä½†æ˜¯ï¼Œä¸åŒäºä¸€èˆ¬äºæˆ‘ä»¬å¸¸è§çš„å¯¹è±¡æ± ã€è¿æ¥æ± ç­‰**æ± åŒ–**çš„æ¡ˆä¾‹ï¼ŒByteBuffer æ˜¯æœ‰**å¤§å°**ä¸€è¯´ã€‚åˆä½†æ˜¯ï¼Œç”³è¯·å¤šå¤§çš„ Direct ByteBuffer è¿›è¡Œæ± åŒ–åˆä¼šæ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œå¤ªå¤§ä¼šæµªè´¹å†…å­˜ï¼Œå¤ªå°åˆä¼šå‡ºç°é¢‘ç¹çš„æ‰©å®¹å’Œå†…å­˜å¤åˆ¶ï¼ï¼ï¼æ‰€ä»¥å‘¢ï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªåˆé€‚çš„å†…å­˜ç®¡ç†ç®—æ³•ï¼Œè§£å†³**é«˜æ•ˆåˆ†é…å†…å­˜**çš„åŒæ—¶åˆè§£å†³**å†…å­˜ç¢ç‰‡åŒ–**çš„é—®é¢˜ã€‚

- **å®˜æ–¹çš„è¯´æ³•**

> FROM [ã€ŠNetty å­¦ä¹ ç¬”è®° â€”â€” Pooled bufferã€‹](https://skyao.gitbooks.io/learning-netty/content/buffer/pooled_buffer.html)
>
> Netty 4.x å¢åŠ äº† Pooled Bufferï¼Œå®ç°äº†é«˜æ€§èƒ½çš„ buffer æ± ï¼Œåˆ†é…ç­–ç•¥åˆ™æ˜¯ç»“åˆäº† buddy allocation å’Œ slab allocation çš„ **jemalloc** å˜ç§ï¼Œä»£ç åœ¨`io.netty.buffer.PoolArena` ä¸­ã€‚
>
> å®˜æ–¹è¯´æä¾›äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š
>
> - é¢‘ç¹åˆ†é…ã€é‡Šæ”¾ buffer æ—¶å‡å°‘äº† GC å‹åŠ›ã€‚
> - åœ¨åˆå§‹åŒ–æ–° buffer æ—¶å‡å°‘å†…å­˜å¸¦å®½æ¶ˆè€—( åˆå§‹åŒ–æ—¶ä¸å¯é¿å…çš„è¦ç»™bufferæ•°ç»„èµ‹åˆå§‹å€¼ )ã€‚
> - åŠæ—¶çš„é‡Šæ”¾ direct buffer ã€‚

- **hushi55 å¤§ä½¬çš„ç†è§£**

> C/C++ å’Œ java ä¸­æœ‰ä¸ªå›´åŸï¼ŒåŸé‡Œçš„æƒ³å‡ºæ¥ï¼ŒåŸå¤–çš„æƒ³è¿›å»ï¼**

è¿™ä¸ªå›´åŸå°±æ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼

**Netty 4 buffer ä»‹ç»**

Netty4 å¸¦æ¥ä¸€ä¸ªä¸ä¼—ä¸åŒçš„ç‰¹ç‚¹æ˜¯å…¶ ByteBuf çš„å®ç°ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œé€šè¿‡ç»´æŠ¤ä¸¤ä¸ªç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆï¼Œ è¦æ¯” `io.netty.buffer.ByteBuf` ç®€å•ä¸å°‘ï¼Œä¹Ÿä¼šæ›´é«˜æ•ˆä¸€äº›ã€‚ä¸è¿‡ï¼ŒNetty çš„ ByteBuf å¸¦ç»™æˆ‘ä»¬çš„æœ€å¤§ä¸åŒï¼Œå°±æ˜¯ä»–ä¸å†åŸºäºä¼ ç»Ÿ JVM çš„ GC æ¨¡å¼ï¼Œç›¸åï¼Œå®ƒé‡‡ç”¨äº†ç±»ä¼¼äº C++ ä¸­çš„ malloc/free çš„æœºåˆ¶ï¼Œéœ€è¦å¼€å‘äººå‘˜æ¥æ‰‹åŠ¨ç®¡ç†å›æ”¶ä¸é‡Šæ”¾ã€‚ä»æ‰‹åŠ¨å†…å­˜ç®¡ç†ä¸Šå‡åˆ°GCï¼Œæ˜¯ä¸€ä¸ªå†å²çš„å·¨å¤§è¿›æ­¥ï¼Œ ä¸è¿‡ï¼Œåœ¨20å¹´åï¼Œå±…ç„¶æœ‰æ›²çº¿çš„å›å½’åˆ°äº†æ‰‹åŠ¨å†…å­˜ç®¡ç†æ¨¡å¼ï¼Œæ­£å°è¯äº†é©¬å…‹æ€å“²å­¦è§‚ï¼š **ç¤¾ä¼šæ€»æ˜¯åœ¨èºæ—‹å¼å‰è¿›çš„ï¼Œæ²¡æœ‰æ°¸è¿œçš„æœ€å¥½ã€‚**

**â‘  GC å†…å­˜ç®¡ç†åˆ†æ**

çš„ç¡®ï¼Œå°±å†…å­˜ç®¡ç†è€Œè¨€ï¼ŒGCå¸¦ç»™æˆ‘ä»¬çš„ä»·å€¼æ˜¯ä¸è¨€è€Œå–»çš„ï¼Œä¸ä»…å¤§å¤§çš„é™ä½äº†ç¨‹åºå‘˜çš„å¿ƒæ™ºåŒ…è¢±ï¼Œ è€Œä¸”ï¼Œä¹Ÿæå¤§çš„å‡å°‘äº†å†…å­˜ç®¡ç†å¸¦æ¥çš„ Crash å›°æ‰°ï¼Œä¸ºå‡½æ•°å¼ç¼–ç¨‹ï¼ˆå¤§é‡çš„ä¸´æ—¶å¯¹è±¡ï¼‰ã€è„šæœ¬è¯­è¨€ç¼–ç¨‹å¸¦æ¥äº†æ˜¥å¤©ã€‚ å¹¶ä¸”ï¼Œé«˜æ•ˆçš„GCç®—æ³•ä¹Ÿè®©å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¨‹åºå¯ä»¥æœ‰æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚ ä¸è¿‡ï¼Œä¹Ÿæœ‰å¾ˆå¤šçš„æƒ…å†µï¼Œå¯èƒ½æ˜¯æ‰‹å·¥å†…å­˜ç®¡ç†æ›´ä¸ºåˆé€‚çš„ã€‚è­¬å¦‚ï¼š

- å¯¹äºç±»ä¼¼äºä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œè­¬å¦‚ç½‘ç»œè·¯ç”±è½¬å‘å‹åº”ç”¨ï¼ˆå¾ˆå¤šerlangåº”ç”¨å…¶å®æ˜¯è¿™ç§ç±»å‹ï¼‰ï¼Œ ä½†æ˜¯ QPS éå¸¸é«˜ï¼Œæ¯”å¦‚1Mçº§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨æ¯æ¬¡å¤„ç†ä¸­å³ä¾¿äº§ç”Ÿ1Kçš„åƒåœ¾ï¼Œéƒ½ä¼šå¯¼è‡´é¢‘ç¹çš„GCäº§ç”Ÿã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œerlang çš„æŒ‰è¿›ç¨‹å›æ”¶æ¨¡å¼ï¼Œæˆ–è€…æ˜¯ C/C++ çš„æ‰‹å·¥å›æ”¶æœºåˆ¶ï¼Œæ•ˆç‡æ›´é«˜ã€‚
- Cache å‹åº”ç”¨ï¼Œç”±äºå¯¹è±¡çš„å­˜åœ¨å‘¨æœŸå¤ªé•¿ï¼ŒGC åŸºæœ¬ä¸Šå°±å˜å¾—æ²¡æœ‰ä»·å€¼ã€‚

æ‰€ä»¥ï¼Œç†è®ºä¸Šï¼Œå°´å°¬çš„GCå®é™…ä¸Šæ¯”è¾ƒé€‚åˆäºå¤„ç†ä»‹äºè¿™ 2 è€…ä¹‹é—´çš„æƒ…å†µï¼š å¯¹è±¡åˆ†é…çš„é¢‘ç¹ç¨‹åº¦ç›¸æ¯”æ•°æ®å¤„ç†çš„æ—¶é—´è¦å°‘å¾—å¤šçš„ï¼Œä½†åˆæ˜¯ç›¸å¯¹çŸ­æš‚çš„ï¼Œ å…¸å‹çš„ï¼Œå¯¹äºOLTPå‹çš„æœåŠ¡ï¼Œå¤„ç†èƒ½åŠ›åœ¨ 1K QPS é‡çº§ï¼Œæ¯ä¸ªè¯·æ±‚çš„å¯¹è±¡åˆ†é…åœ¨ 10K-50K é‡çº§ï¼Œ èƒ½å¤Ÿåœ¨ 5-10s çš„æ—¶é—´å†…è¿›è¡Œä¸€ æ¬¡younger GC ï¼Œæ¯æ¬¡GCçš„æ—¶é—´å¯ä»¥æ§åˆ¶åœ¨ 10ms æ°´å¹³ä¸Šï¼Œ è¿™ç±»çš„åº”ç”¨ï¼Œå®åœ¨æ˜¯å¤ªé€‚åˆ GC è¡Œçš„æ¨¡å¼äº†ï¼Œè€Œä¸”ç»“åˆ Java é«˜æ•ˆçš„åˆ†ä»£ GC ï¼Œç®€ç›´å°±æ˜¯ä¸€ä¸ªç†æƒ³æ­é…ã€‚

**â‘¡ å½±å“**

Netty 4 å¼•å…¥äº†æ‰‹å·¥å†…å­˜çš„æ¨¡å¼ï¼Œæˆ‘è§‰å¾—è¿™æ˜¯ä¸€å¤§åˆ›æ–°ï¼Œè¿™ç§æ¨¡å¼ç”šè‡³äºä¼šå»¶å±•ï¼Œ åº”ç”¨åˆ° Cache åº”ç”¨ä¸­ã€‚å®é™…ä¸Šï¼Œç»“åˆ JVM çš„è¯¸å¤šä¼˜ç§€ç‰¹æ€§ï¼Œå¦‚æœç”¨ Java æ¥å®ç°ä¸€ä¸ª Redis å‹ Cacheã€ æˆ–è€… In-memory SQL Engineï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª Mongo DBï¼Œæˆ‘è§‰å¾—ç›¸æ¯” C/C++ è€Œè¨€ï¼Œéƒ½è¦æ›´ç®€å•å¾ˆå¤šã€‚ å®é™…ä¸Šï¼ŒJVM ä¹Ÿå·²ç»æä¾›äº†æ‰“é€šè¿™ç§æŠ€æœ¯çš„æœºåˆ¶ï¼Œå°±æ˜¯ Direct Memory å’Œ Unsafe å¯¹è±¡ã€‚ åŸºäºè¿™ä¸ªåŸºç¡€ï¼Œæˆ‘ä»¬å¯ä»¥åƒ C è¯­è¨€ä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ã€‚å®é™…ä¸Šï¼ŒNetty4 çš„ ByteBuf ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªåŸºç¡€çš„ã€‚



**Netty å¦‚ä½•å®ç°å†…å­˜ç®¡ç†ï¼Ÿ**

Netty å†…å­˜ç®¡ç†æœºåˆ¶ï¼ŒåŸºäº [Jemalloc](http://www.cnhalo.net/2016/06/13/memory-optimize/) ç®—æ³•ã€‚

- é¦–å…ˆä¼šé¢„ç”³è¯·ä¸€å¤§å—å†…å­˜ **Arena** ï¼ŒArena ç”±è®¸å¤š Chunk ç»„æˆï¼Œè€Œæ¯ä¸ª Chunk é»˜è®¤ç”±2048ä¸ªpageç»„æˆã€‚
- **Chunk** é€šè¿‡ **AVL** æ ‘çš„å½¢å¼ç»„ç»‡ **Page** ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ª Page ï¼Œè€Œä¸­é—´èŠ‚ç‚¹è¡¨ç¤ºå†…å­˜åŒºåŸŸï¼ŒèŠ‚ç‚¹è‡ªå·±è®°å½•å®ƒåœ¨æ•´ä¸ª Arena ä¸­çš„åç§»åœ°å€ã€‚å½“åŒºåŸŸè¢«åˆ†é…å‡ºå»åï¼Œä¸­é—´èŠ‚ç‚¹ä¸Šçš„æ ‡è®°ä½ä¼šè¢«æ ‡è®°ï¼Œè¿™æ ·å°±è¡¨ç¤ºè¿™ä¸ªä¸­é—´èŠ‚ç‚¹ä»¥ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å·²è¢«åˆ†é…äº†ã€‚å¤§äº 8k çš„å†…å­˜åˆ†é…åœ¨ **PoolChunkList** ä¸­ï¼Œè€Œ **PoolSubpage** ç”¨äºåˆ†é…å°äº 8k çš„å†…å­˜ï¼Œå®ƒä¼šæŠŠä¸€ä¸ª page åˆ†å‰²æˆå¤šæ®µï¼Œè¿›è¡Œå†…å­˜åˆ†é…ã€‚

![](./pic/04.png)

![](./pic/05.png)



**ä»€ä¹ˆæ˜¯ Netty çš„å†…å­˜æ³„éœ²æ£€æµ‹ï¼Ÿæ˜¯å¦‚ä½•è¿›è¡Œå®ç°çš„ï¼Ÿ**

æ¨èé˜…è¯»å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠNetty ä¹‹æœ‰æ•ˆè§„é¿å†…å­˜æ³„æ¼ã€‹](http://calvin1978.blogcn.com/articles/netty-leak.html) ä»åŸç†å±‚é¢è§£é‡Šã€‚
- ã€ŠBuffer ä¹‹ ByteBufï¼ˆä¸‰ï¼‰å†…å­˜æ³„éœ²æ£€æµ‹ä»æºç å±‚é¢è§£è¯»ã€‚

å¦å¤–ï¼ŒNetty çš„å†…å­˜æ³„éœ²æ£€æµ‹çš„å®ç°ï¼Œæ˜¯å¯¹ WeakReference å’Œ ReferenceQueue å¾ˆå¥½çš„å­¦ä¹ ã€‚ä¹‹å‰å¾ˆå¤šèƒ–å‹åœ¨çœ‹äº† [ã€ŠJava ä¸­çš„å››ç§å¼•ç”¨ç±»å‹ã€‹](http://www.iocoder.cn/Fight/Four-reference-types-in-Java) ä¹‹åï¼Œæ˜¯ä¸å¤ªç†è§£ Java çš„å››ç§å¼•ç”¨çš„å…·ä½“ä½¿ç”¨åœºæ™¯ï¼Œè¿™ä¸å°±æ¥äº†ä¹ˆã€‚

æ£€æµ‹æ­¥éª¤å¦‚ä¸‹

- åˆ›å»ºByteBufçš„æ—¶å€™ï¼Œå¦‚æœè¢«é€‰ä¸ºéœ€è¦æ£€æµ‹å†…å­˜æ³„éœ²ã€‚ åˆ™è°ƒç”¨`ResourceLeakDetector.track(buf)`è¿”å›ä¸€ä¸ªResourceLeakTrackerå¯¹è±¡ï¼ˆè¿™ä¸ªå¯¹è±¡æ˜¯ä¸ªWeakReferenceå¯¹è±¡ï¼‰ã€‚åŒæ—¶è¿™ä¸ªResourceLeakTrackerä¼šè¢«æ·»åŠ åˆ°`ResourceLeakDetector.allLeaks`è¿™ä¸ªé›†åˆä¸­å»

- å°†è¯¥ByteBufå’Œleakä¸€èµ·å°è£…è¿›`SimpleLeakAwareByteBuf`æˆ–è€…`AdvancedLeakAwareByteBuf`

- å½“ByteBufä½¿ç”¨å®Œï¼Œæ­£å¸¸æƒ…å†µä¼šè°ƒç”¨releaseï¼Œè¿™æ—¶å€™ä¼šåœ¨é‡Šæ”¾å†…å­˜çš„åŒæ—¶ï¼Œå°†å±äºå®ƒçš„ResourceLeakTrackerå¯¹è±¡ä»`ResourceLeakDetector.allLeaks`ä¸­ç§»é™¤ã€‚

- ç°åœ¨ï¼ŒByteBufç”¨å®Œäº†ï¼Œè¢«GCäº†ï¼Œåˆ™å±äºè¿™ä¸ªByteBufçš„ResourceLeakTrackerå¯¹è±¡ä¼šåŠ å…¥åˆ°ä¸€ä¸ªqueueé‡Œé¢(å› ä¸ºå®ƒæ˜¯WeakReference)ï¼Œæˆ‘ä»¬ä¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹å»æ£€æŸ¥è¿™ä¸ªqueueé‡Œé¢çš„æ¯ä¸ªResourceLeakTrackerå¯¹è±¡ã€‚

  å¯¹æ¯ä¸ªResourceLeakTrackerå¯¹è±¡è°ƒç”¨`allLeks.remove(leak)`ï¼Œå¦‚æœè¿”å›trueï¼Œæ„å‘³ç€è¯¥ResourceLeakTrackerå¯¹è±¡è¿˜å­˜åœ¨äº`ResourceLeakDetector.allLeaks`é›†åˆä¸­ï¼Œè¯´æ˜äº†å…¶å¯¹åº”çš„ByteBufåœ¨è¢«GCå‰ï¼Œæ²¡æœ‰è°ƒç”¨release()ï¼Œæ²¡æœ‰å½’è¿˜å†…å­˜ç©ºé—´ï¼Œè¯æ˜äº†å†…å­˜æ³„éœ²çš„å­˜åœ¨ã€‚è¿”å›falseæ‰æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚



**å†…å­˜æ± /éå†…å­˜æ± çš„é»˜è®¤é€‰æ‹©åŠåˆ‡æ¢æ–¹å¼ï¼Ÿ**

é™¤äº†å®‰å“ï¼Œé»˜è®¤ä½¿ç”¨å†…å­˜æ± ï¼Œå¯é€šè¿‡.childOption()æ˜¾ç¤ºæŒ‡å®šï¼Œæˆ–è€…io.netty.allocator.typeå»æŒ‡å®šã€‚



### è¯´è¯´ Netty å¦‚ä½•å®ç°é«˜æ€§èƒ½ï¼Ÿ

1. **çº¿ç¨‹æ¨¡å‹** ï¼šæ›´åŠ ä¼˜é›…çš„ Reactor æ¨¡å¼å®ç°ã€çµæ´»çš„çº¿ç¨‹æ¨¡å‹ã€åˆ©ç”¨ EventLoop ç­‰åˆ›æ–°æ€§çš„æœºåˆ¶ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆåœ°ç®¡ç†æˆç™¾ä¸Šåƒçš„ Channel ã€‚
2. **å †å¤–å†…å­˜** ï¼šTCP æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºé‡‡ç”¨ç›´æ¥å†…å­˜ä»£æ›¿å †å†…å­˜ï¼Œé¿å…äº†å†…å­˜å¤åˆ¶ï¼Œæå‡äº† I/O è¯»å–å’Œå†™å…¥æ€§èƒ½ã€‚
3. **å†…å­˜æ± è®¾è®¡** ï¼šæ”¯æŒé€šè¿‡å†…å­˜æ± çš„æ–¹å¼å¾ªç¯åˆ©ç”¨ ByteBufï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ ByteBuf å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ã€‚
4. **å‚æ•°é…ç½®** ï¼šå¯é…ç½®çš„ I/O çº¿ç¨‹æ•°ç›®å’Œ TCP å‚æ•°ç­‰ï¼Œä¸ºä¸åŒç”¨æˆ·æä¾›å®šåˆ¶åŒ–çš„è°ƒä¼˜å‚æ•°ï¼Œæ»¡è¶³ä¸åŒçš„æ€§èƒ½åœºæ™¯ã€‚
5. **å†…å­˜æ³„éœ²æ£€æµ‹** ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°å™¨åŠæ—¶åœ°é‡Šæ”¾ä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œç»†ç²’åº¦çš„å†…å­˜ç®¡ç†é™ä½äº† GC çš„é¢‘ç‡ï¼Œå‡å°‘é¢‘ç¹ GC å¸¦æ¥çš„æ—¶å»¶å¢å¤§å’Œ CPU æŸè€—ã€‚
6. Jemallcoå†…å­˜åˆ†é…ç®—æ³•

### Netty çš„é«˜å¯é å¦‚ä½•ä½“ç°ï¼Ÿ

- é“¾è·¯æœ‰æ•ˆæ€§æ£€æµ‹ï¼šç”±äºé•¿è¿æ¥ä¸éœ€è¦æ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½åˆ›å»ºé“¾è·¯ï¼Œä¹Ÿä¸éœ€è¦åœ¨æ¶ˆæ¯å®Œæˆäº¤äº’æ—¶å…³é—­é“¾è·¯ï¼Œå› æ­¤ç›¸å¯¹äºçŸ­è¿æ¥æ€§èƒ½æ›´é«˜ã€‚ä¸ºäº†ä¿è¯é•¿è¿æ¥çš„é“¾è·¯æœ‰æ•ˆæ€§ï¼Œå¾€å¾€éœ€è¦é€šè¿‡å¿ƒè·³æœºåˆ¶å‘¨æœŸæ€§åœ°è¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚ä½¿ç”¨å¿ƒè·³æœºåˆ¶çš„åŸå› æ˜¯ï¼Œé¿å…åœ¨ç³»ç»Ÿç©ºé—²æ—¶å› ç½‘ç»œé—ªæ–­è€Œæ–­å¼€è¿æ¥ï¼Œä¹‹ååˆé‡åˆ°æµ·é‡ä¸šåŠ¡å†²å‡»å¯¼è‡´æ¶ˆæ¯ç§¯å‹æ— æ³•å¤„ç†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å‘¨æœŸæ€§åœ°å¯¹é“¾è·¯è¿›è¡Œæœ‰æ•ˆæ€§æ£€æµ‹ï¼Œä¸€æ—¦å‘ç°é—®é¢˜ï¼Œå¯ä»¥åŠæ—¶å…³é—­é“¾è·¯ï¼Œé‡å»º TCP è¿æ¥ã€‚ä¸ºäº†æ”¯æŒå¿ƒè·³ï¼ŒNetty æä¾›äº†ä¸¤ç§é“¾è·¯ç©ºé—²æ£€æµ‹æœºåˆ¶ï¼š
  - è¯»ç©ºé—²è¶…æ—¶æœºåˆ¶ï¼šè¿ç»­ T å‘¨æœŸæ²¡æœ‰æ¶ˆæ¯å¯è¯»æ—¶ï¼Œå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œè¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚å¦‚æœè¿ç»­ N ä¸ªå‘¨æœŸæ²¡æœ‰è¯»å–åˆ°å¿ƒè·³æ¶ˆæ¯ï¼Œå¯ä»¥ä¸»åŠ¨å…³é—­é“¾è·¯ï¼Œé‡å»ºè¿æ¥ã€‚
  - å†™ç©ºé—²è¶…æ—¶æœºåˆ¶ï¼šè¿ç»­ T å‘¨æœŸæ²¡æœ‰æ¶ˆæ¯éœ€è¦å‘é€æ—¶ï¼Œå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œè¿›è¡Œé“¾è·¯æ£€æµ‹ã€‚å¦‚æœè¿ç»­ N ä¸ªå‘¨æœŸæ²¡æœ‰è¯»å–å¯¹æ–¹å‘å›çš„å¿ƒè·³æ¶ˆæ¯ï¼Œå¯ä»¥ä¸»åŠ¨å…³é—­é“¾è·¯ï¼Œé‡å»ºè¿æ¥ã€‚
- å†…å­˜ä¿æŠ¤æœºåˆ¶ï¼šNetty æä¾›å¤šç§æœºåˆ¶å¯¹å†…å­˜è¿›è¡Œä¿æŠ¤ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
  - é€šè¿‡å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å¯¹ ByteBuf è¿›è¡Œç»†ç²’åº¦çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾ï¼ŒåŠæ—¶æ¸…ç†å†…å­˜ã€‚
  - å†…å­˜æ³„éœ²æ„ŸçŸ¥ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚
- **ä¼˜é›…åœæœº**ï¼šä¼˜é›…åœæœºåŠŸèƒ½æŒ‡çš„æ˜¯å½“ç³»ç»Ÿæ¨å‡ºæ—¶ï¼ŒJVM é€šè¿‡æ³¨å†Œçš„ Shutdown Hook æ‹¦æˆªåˆ°é€€å‡ºä¿¡å·é‡ï¼Œç„¶åæ‰§è¡Œé€€å‡ºæ“ä½œï¼Œé‡Šæ”¾ç›¸å…³æ¨¡å—çš„èµ„æºå ç”¨ï¼Œå°†ç¼“å†²åŒºçš„æ¶ˆæ¯å¤„ç†å®Œæˆæˆ–æ¸…ç©ºï¼Œå°†å¾…åˆ·æ–°çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜å’Œæ•°æ®åº“ä¸­ï¼Œç­‰åˆ°èµ„æºå›æ”¶å’Œç¼“å†²åŒºæ¶ˆæ¯å¤„ç†å®Œæˆä¹‹åï¼Œå†é€€å‡ºã€‚

### Netty çš„å¯æ‰©å±•å¦‚ä½•ä½“ç°ï¼Ÿ

å¯å®šåˆ¶ã€æ˜“æ‰©å±•ã€‚

- **è´£ä»»é“¾æ¨¡å¼** ï¼šChannelPipeline åŸºäºè´£ä»»é“¾æ¨¡å¼å¼€å‘ï¼Œä¾¿äºä¸šåŠ¡é€»è¾‘çš„æ‹¦æˆªã€å®šåˆ¶å’Œæ‰©å±•ã€‚
- **åŸºäºæ¥å£çš„å¼€å‘** ï¼šå…³é”®çš„ç±»åº“éƒ½æä¾›äº†æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œä¾¿äºç”¨æˆ·è‡ªå®šä¹‰å®ç°ã€‚
- **æä¾›å¤§é‡çš„å·¥å‚ç±»** ï¼šé€šè¿‡é‡è½½è¿™äº›å·¥å‚ç±»ï¼Œå¯ä»¥æŒ‰éœ€åˆ›å»ºå‡ºç”¨æˆ·éœ€è¦çš„å¯¹è±¡ã€‚
- **æä¾›å¤§é‡ç³»ç»Ÿå‚æ•°** ï¼šä¾›ç”¨æˆ·æŒ‰éœ€è®¾ç½®ï¼Œå¢å¼ºç³»ç»Ÿçš„åœºæ™¯å®šåˆ¶æ€§ã€‚

------

> å®é™…ä¸Šï¼Œä»»ä½•çš„æŠ€æœ¯çš„ç ”ç©¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å»æ€è€ƒï¼Œå®ƒçš„é«˜æ€§èƒ½æ˜¯æ€ä¹ˆä½“ç°çš„ï¼Œå®ƒçš„å¯é æ€§æ˜¯æ€ä¹ˆä½“ç°çš„ï¼Œå®ƒçš„å¯æ‹“å±•æ˜¯æ€ä¹ˆä½“ç°çš„ã€‚
>
> å½“ç„¶ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™æœ‰è¿‘ä¹‰è¯ï¼Œæ‰€ä»¥ï¼š
>
> - é«˜æ€§èƒ½ => é«˜å¹¶å‘
> - å¯é æ€§ => é«˜å¯ç”¨
> - å¯æ‹“å±• => é«˜æ‹“å±•

### ç®€å•ä»‹ç» Netty çš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ

Netty æœ‰å¦‚ä¸‹å…­ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

- Bootstrap & ServerBootstrap
- Channel
- ChannelFuture
- EventLoop & EventLoopGroup
- ChannelHandler
- ChannelPipeline

è¯¦ç»†çš„ï¼Œè¯·ç›´æ¥é˜…è¯» [ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” Netty ç®€ä»‹ï¼ˆäºŒï¼‰ä¹‹æ ¸å¿ƒç»„ä»¶ã€‹](http://svip.iocoder.cn/Netty/intro-2/) ä¸€æ–‡ã€‚



### ä»€ä¹ˆæ˜¯ä¸šåŠ¡çº¿ç¨‹æ± ï¼Ÿ

- **é—®é¢˜**

åœ¨ [ã€Œä»€ä¹ˆæ˜¯ Reactor æ¨¡å‹ï¼Ÿã€](http://svip.iocoder.cn/Netty/Interview/#) é—®é¢˜ä¸­ï¼Œæ— è®ºæ˜¯é‚£ç§ç±»å‹çš„ Reactor æ¨¡å‹ï¼Œéƒ½éœ€è¦åœ¨ Reactor æ‰€åœ¨çš„çº¿ç¨‹ä¸­ï¼Œè¿›è¡Œè¯»å†™æ“ä½œã€‚é‚£ä¹ˆæ­¤æ—¶å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬è¯»å–åˆ°æ•°æ®ï¼Œéœ€è¦è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¹¶ä¸”è¿™ä¸ªä¸šåŠ¡é€»è¾‘éœ€è¦å¯¹æ•°æ®åº“ã€ç¼“å­˜ç­‰ç­‰è¿›è¡Œæ“ä½œï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾è¿™ä¸ªæ•°æ®åº“æ“ä½œéœ€è¦ 5 ms ï¼Œé‚£å°±æ„å‘³ç€è¿™ä¸ª Reactor çº¿ç¨‹åœ¨è¿™ 5 ms æ— æ³•è¿›è¡Œæ³¨å†Œåœ¨è¿™ä¸ª Reactor çš„ Channel è¿›è¡Œè¯»å†™æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šä¸ª Channel çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½å˜æˆäº†ä¸²è¡Œã€‚åŠ¿å¿…ï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šéå¸¸éå¸¸éå¸¸çš„ä½ã€‚

- **è§£å†³**

é‚£ä¹ˆæ€ä¹ˆè§£å†³å‘¢ï¼Ÿåˆ›å»ºä¸šåŠ¡çº¿ç¨‹æ± ï¼Œå°†è¯»å–åˆ°çš„æ•°æ®ï¼Œæäº¤åˆ°ä¸šåŠ¡çº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ã€‚è¿™æ ·ï¼ŒReactor çš„ Channel å°±ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œ Channel çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½å˜æˆäº†å¹¶è¡Œäº†ã€‚

- **æ¡ˆä¾‹**

å¦‚æœèƒ–å‹ç†Ÿæ‚‰ Dubbo æ¡†æ¶ï¼Œå°±ä¼šå‘ç° [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html) ã€‚ğŸ˜ˆ è®¤çœŸè¯»ä¸‹ï¼Œå¯ä»¥è·Ÿé¢è¯•å®˜å¹ä¸€å¹å•¦ã€‚

### selectã€pollã€epollä¹‹é—´çš„åŒºåˆ«

(1)select==>æ—¶é—´å¤æ‚åº¦O(n)

å®ƒä»…ä»…çŸ¥é“äº†ï¼Œæœ‰I/Oäº‹ä»¶å‘ç”Ÿäº†ï¼Œå´å¹¶ä¸çŸ¥é“æ˜¯å“ªé‚£å‡ ä¸ªæµï¼ˆå¯èƒ½æœ‰ä¸€ä¸ªï¼Œå¤šä¸ªï¼Œç”šè‡³å…¨éƒ¨ï¼‰ï¼Œæˆ‘ä»¬åªèƒ½æ— å·®åˆ«è½®è¯¢æ‰€æœ‰æµï¼Œæ‰¾å‡ºèƒ½è¯»å‡ºæ•°æ®ï¼Œæˆ–è€…å†™å…¥æ•°æ®çš„æµï¼Œå¯¹ä»–ä»¬è¿›è¡Œæ“ä½œã€‚æ‰€ä»¥**selectå…·æœ‰O(n)çš„æ— å·®åˆ«è½®è¯¢å¤æ‚åº¦**ï¼ŒåŒæ—¶å¤„ç†çš„æµè¶Šå¤šï¼Œæ— å·®åˆ«è½®è¯¢æ—¶é—´å°±è¶Šé•¿ã€‚

(2)poll==>æ—¶é—´å¤æ‚åº¦O(n)

pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒå°†ç”¨æˆ·ä¼ å…¥çš„æ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åæŸ¥è¯¢æ¯ä¸ªfdå¯¹åº”çš„è®¾å¤‡çŠ¶æ€ï¼Œ **ä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶**ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„.

(3)epoll==>æ—¶é—´å¤æ‚åº¦O(1)

**epollå¯ä»¥ç†è§£ä¸ºevent poll**ï¼Œä¸åŒäºå¿™è½®è¯¢å’Œæ— å·®åˆ«è½®è¯¢ï¼Œepollä¼šæŠŠå“ªä¸ªæµå‘ç”Ÿäº†æ€æ ·çš„I/Oäº‹ä»¶é€šçŸ¥æˆ‘ä»¬ã€‚æ‰€ä»¥æˆ‘ä»¬è¯´epollå®é™…ä¸Šæ˜¯**äº‹ä»¶é©±åŠ¨ï¼ˆæ¯ä¸ªäº‹ä»¶å…³è”ä¸Šfdï¼‰**çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹è¿™äº›æµçš„æ“ä½œéƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚**ï¼ˆå¤æ‚åº¦é™ä½åˆ°äº†O(1)ï¼‰**

epollæœ‰EPOLLLTå’ŒEPOLLETä¸¤ç§è§¦å‘æ¨¡å¼ï¼ŒLTæ˜¯é»˜è®¤çš„æ¨¡å¼ï¼ŒETæ˜¯â€œé«˜é€Ÿâ€æ¨¡å¼ã€‚LTæ¨¡å¼ä¸‹ï¼Œåªè¦è¿™ä¸ªfdè¿˜æœ‰æ•°æ®å¯è¯»ï¼Œæ¯æ¬¡ epoll_waitéƒ½ä¼šè¿”å›å®ƒçš„äº‹ä»¶ï¼Œæé†’ç”¨æˆ·ç¨‹åºå»æ“ä½œï¼Œè€Œåœ¨ETï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰æ¨¡å¼ä¸­ï¼Œå®ƒåªä¼šæç¤ºä¸€æ¬¡ï¼Œç›´åˆ°ä¸‹æ¬¡å†æœ‰æ•°æ®æµå…¥ä¹‹å‰éƒ½ä¸ä¼šå†æç¤ºäº†ï¼Œæ—  è®ºfdä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®å¯è¯»ã€‚æ‰€ä»¥åœ¨ETæ¨¡å¼ä¸‹ï¼Œreadä¸€ä¸ªfdçš„æ—¶å€™ä¸€å®šè¦æŠŠå®ƒçš„bufferè¯»å…‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ç›´è¯»åˆ°readçš„è¿”å›å€¼å°äºè¯·æ±‚å€¼ï¼Œæˆ–è€… é‡åˆ°EAGAINé”™è¯¯ã€‚è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œepollä½¿ç”¨â€œäº‹ä»¶â€çš„å°±ç»ªé€šçŸ¥æ–¹å¼ï¼Œé€šè¿‡epoll_ctlæ³¨å†Œfdï¼Œä¸€æ—¦è¯¥fdå°±ç»ªï¼Œå†…æ ¸å°±ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶æ¥æ¿€æ´»è¯¥fdï¼Œepoll_waitä¾¿å¯ä»¥æ”¶åˆ°é€šçŸ¥ã€‚

**epollçš„ä¼˜ç‚¹ï¼š**

1ã€**æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024ï¼ˆ1Gçš„å†…å­˜ä¸Šèƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£ï¼‰**ï¼›
**2ã€æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™ã€‚åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼›**
**å³Epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ŒEpollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚**

3ã€ å†…å­˜æ‹·è´ï¼Œåˆ©ç”¨mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼›å³epollä½¿ç”¨mmapå‡å°‘å¤åˆ¶å¼€é”€ã€‚



**selectã€pollã€epoll åŒºåˆ«æ€»ç»“ï¼š**

1ã€æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°

select

å•ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°æœ‰FD_SETSIZEå®å®šä¹‰ï¼Œå…¶å¤§å°æ˜¯32ä¸ªæ•´æ•°çš„å¤§å°ï¼ˆåœ¨32ä½çš„æœºå™¨ä¸Šï¼Œå¤§å°å°±æ˜¯32*32ï¼ŒåŒç†64ä½æœºå™¨ä¸ŠFD_SETSIZEä¸º32*64ï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥å¯¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä½†æ˜¯æ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ï¼Œè¿™éœ€è¦è¿›ä¸€æ­¥çš„æµ‹è¯•ã€‚

poll

pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„

epoll

è™½ç„¶è¿æ¥æ•°æœ‰ä¸Šé™ï¼Œä½†æ˜¯å¾ˆå¤§ï¼Œ1Gå†…å­˜çš„æœºå™¨ä¸Šå¯ä»¥æ‰“å¼€10ä¸‡å·¦å³çš„è¿æ¥ï¼Œ2Gå†…å­˜çš„æœºå™¨å¯ä»¥æ‰“å¼€20ä¸‡å·¦å³çš„è¿æ¥

2ã€FDå‰§å¢åå¸¦æ¥çš„IOæ•ˆç‡é—®é¢˜

select

å› ä¸ºæ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šå¯¹è¿æ¥è¿›è¡Œçº¿æ€§éå†ï¼Œæ‰€ä»¥éšç€FDçš„å¢åŠ ä¼šé€ æˆéå†é€Ÿåº¦æ…¢çš„â€œçº¿æ€§ä¸‹é™æ€§èƒ½é—®é¢˜â€ã€‚

poll

åŒä¸Š

epoll

å› ä¸ºepollå†…æ ¸ä¸­å®ç°æ˜¯æ ¹æ®æ¯ä¸ªfdä¸Šçš„callbackå‡½æ•°æ¥å®ç°çš„ï¼Œåªæœ‰æ´»è·ƒçš„socketæ‰ä¼šä¸»åŠ¨è°ƒç”¨callbackï¼Œæ‰€ä»¥åœ¨æ´»è·ƒsocketè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨epollæ²¡æœ‰å‰é¢ä¸¤è€…çš„çº¿æ€§ä¸‹é™çš„æ€§èƒ½é—®é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰socketéƒ½å¾ˆæ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚

3ã€ æ¶ˆæ¯ä¼ é€’æ–¹å¼

select

å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œéƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ

poll

åŒä¸Š

epoll

epollé€šè¿‡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„ã€‚

**æ€»ç»“ï¼š**

**ç»¼ä¸Šï¼Œåœ¨é€‰æ‹©selectï¼Œpollï¼Œepollæ—¶è¦æ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºåˆä»¥åŠè¿™ä¸‰ç§æ–¹å¼çš„è‡ªèº«ç‰¹ç‚¹ã€‚**

**1ã€è¡¨é¢ä¸Šçœ‹epollçš„æ€§èƒ½æœ€å¥½ï¼Œä½†æ˜¯åœ¨è¿æ¥æ•°å°‘å¹¶ä¸”è¿æ¥éƒ½ååˆ†æ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œselectå’Œpollçš„æ€§èƒ½å¯èƒ½æ¯”epollå¥½ï¼Œæ¯•ç«Ÿepollçš„é€šçŸ¥æœºåˆ¶éœ€è¦å¾ˆå¤šå‡½æ•°å›è°ƒã€‚**

**2ã€selectä½æ•ˆæ˜¯å› ä¸ºæ¯æ¬¡å®ƒéƒ½éœ€è¦è½®è¯¢ã€‚ä½†ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè§†æƒ…å†µè€Œå®šï¼Œä¹Ÿå¯é€šè¿‡è‰¯å¥½çš„è®¾è®¡æ”¹å–„**

### åŸç”Ÿçš„ NIO å­˜åœ¨ Epoll Bug æ˜¯ä»€ä¹ˆï¼ŸNetty æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ

- **Java NIO Epoll BUG**

Java NIO Epoll ä¼šå¯¼è‡´ Selector ç©ºè½®è¯¢ï¼Œæœ€ç»ˆå¯¼è‡´ CPU 100% ã€‚

å®˜æ–¹å£°ç§°åœ¨ JDK 1.6 ç‰ˆæœ¬çš„ update18 ä¿®å¤äº†è¯¥é—®é¢˜ï¼Œä½†æ˜¯ç›´åˆ° JDK 1.7 ç‰ˆæœ¬è¯¥é—®é¢˜ä»æ—§å­˜åœ¨ï¼Œåªä¸è¿‡è¯¥ BUG å‘ç”Ÿæ¦‚ç‡é™ä½äº†ä¸€äº›è€Œå·²ï¼Œå®ƒå¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬æ€§è§£å†³ã€‚

- **Netty è§£å†³æ–¹æ¡ˆ**

å¯¹ Selector çš„ select æ“ä½œå‘¨æœŸè¿›è¡Œ**ç»Ÿè®¡**ï¼Œæ¯å®Œæˆä¸€æ¬¡**ç©º**çš„ select æ“ä½œè¿›è¡Œä¸€æ¬¡è®¡æ•°ï¼Œè‹¥åœ¨æŸä¸ªå‘¨æœŸï¼ˆé»˜è®¤1sï¼‰å†…è¿ç»­å‘ç”Ÿ Nï¼ˆé»˜è®¤512ï¼‰ æ¬¡ç©ºè½®è¯¢ï¼Œåˆ™åˆ¤æ–­è§¦å‘äº† Epoll æ­»å¾ªç¯ Bug ã€‚

> æ­¤å¤„**ç©º**çš„ select æ“ä½œçš„å®šä¹‰æ˜¯ï¼Œselect æ“ä½œæ‰§è¡Œäº† 0 æ¯«ç§’ã€‚

æ­¤æ—¶ï¼ŒNetty **é‡å»º** Selector æ¥è§£å†³ã€‚å°†åŸ SocketChannel ä»æ—§çš„ Selector ä¸Šå–æ¶ˆæ³¨å†Œï¼Œç„¶åé‡æ–°æ³¨å†Œåˆ°æ–°çš„ Selector ä¸Šï¼Œæœ€åå°†åŸæ¥çš„ Selector å…³é—­ã€‚



### NettyæœåŠ¡å™¨å¯åŠ¨æµç¨‹

å¯åŠ¨æœåŠ¡çš„æœ¬è´¨ï¼š 

```java
// 1. åœ¨new NioEventLoopGroup()æ—¶ï¼Œåˆ›å»ºSelector
Selector selector = sun.nio.ch.SelectorProviderImpl.openSelector() 

// 2.åˆ›å»ºSocketChannel
ServerSocketChannel serverSocketChannel = provider.openServerSocketChannel() 

// 3. å°†SocketChannelæ³¨å†Œåˆ°selectorä¸Š
selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this); 

// 4. å°†SocketChannelä¸localAddressç»‘å®š
javaChannel().bind(localAddress, config.getBacklog()); 

// 5. ç›‘å¬OP_ACCEPTäº‹ä»¶
selectionKey.interestOps(OP_ACCEPT);
```

- Selector æ˜¯åœ¨ new NioEventLoopGroup()ï¼ˆåˆ›å»ºä¸€æ‰¹ NioEventLoopï¼‰æ—¶åˆ›å»ºã€‚ 
- ç¬¬ä¸€æ¬¡ Register å¹¶ä¸æ˜¯ç›‘å¬ OP_ACCEPTï¼Œè€Œæ˜¯ 0: selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this) ã€‚
- æœ€ç»ˆç›‘å¬ OP_ACCEPT æ˜¯é€šè¿‡ bind å®Œæˆåçš„ fireChannelActive() æ¥è§¦å‘çš„ã€‚
- NioEventLoop æ˜¯é€šè¿‡ Register æ“ä½œçš„æ‰§è¡Œæ¥å®Œæˆå¯åŠ¨çš„ã€‚ 
- ç±»ä¼¼ ChannelInitializerï¼Œä¸€äº› Hander å¯ä»¥è®¾è®¡æˆä¸€æ¬¡æ€§çš„ï¼Œç”¨å®Œå°±ç§»é™¤ï¼Œä¾‹å¦‚æˆæƒã€‚



### Nettyåˆ›å»ºè¿æ¥æµç¨‹

```java
	// 1. å‘ç° OP_ACCEPT äº‹ä»¶
	selector.select()/selectNow()/select(timeoutMillis) 
  
	// 2. é€šè¿‡serverSocketChannelåˆ›å»ºSocketChannel
  SocketChannel socketChannel = serverSocketChannel.accept()
    
  // 3. å°†åˆ›å»ºçš„SocketChannelæ³¨å†Œåˆ°work EventLoopGroupçš„selectorä¸Š
  selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), 0, this);

	// 4. æ³¨å†ŒOP_READäº‹ä»¶
	selectionKey.interestOps(OP_READ);
```



### Nettyè¯»å–æ•°æ®æµç¨‹

1. å¤šè·¯å¤ç”¨å™¨ï¼ˆ Selector ï¼‰æ¥æ”¶åˆ° OP_READ äº‹ä»¶
2. å¤„ç† OP_READ äº‹ä»¶ï¼šNioSocketChannel.NioSocketChannelUnsafe.read()
   1. åˆ†é…ä¸€ä¸ªåˆå§‹ 1024 å­—èŠ‚çš„ byte buffer æ¥æ¥å—æ•°æ®
   2. ä» Channel æ¥å—æ•°æ®åˆ° byte buffer
   3. è®°å½•å®é™…æ¥å—æ•°æ®å¤§å°ï¼Œè°ƒæ•´ä¸‹æ¬¡åˆ†é… byte buffer å¤§å°
   4. è§¦å‘ pipeline.fireChannelRead(byteBuf) æŠŠè¯»å–åˆ°çš„æ•°æ®ä¼ æ’­å‡ºå»
   5. åˆ¤æ–­æ¥å— byte buffer æ˜¯å¦æ»¡è½½è€Œå½’ï¼šæ˜¯ï¼Œå°è¯•ç»§ç»­è¯»å–ç›´åˆ°æ²¡æœ‰æ•°æ®æˆ–æ»¡ 16 æ¬¡ï¼› å¦ï¼Œç»“æŸæœ¬è½®è¯»å–ï¼Œè§¦å‘pipeline.fireChannelReadComplete()ã€‚ç­‰å¾…ä¸‹æ¬¡ OP_READ äº‹ä»¶

- è¯»å–æ•°æ®æœ¬è´¨ï¼šsun.nio.ch.SocketChannelImpl#read(java.nio.ByteBuffer)
- NioSocketChannel read() æ˜¯è¯»æ•°æ®ï¼Œ NioServerSocketChannel read() æ˜¯åˆ›å»ºè¿æ¥
- ä¸ºä»€ä¹ˆæœ€å¤šåªå°è¯•è¯»å– 16 æ¬¡ï¼Ÿâ€œé›¨éœ²å‡æ²¾â€



 ### Nettyä¸šåŠ¡å¤„ç†

ä¸šåŠ¡å¤„ç†å‘ç”Ÿåœ¨åœ¨å¤„ç†OP_READè¿‡ç¨‹ä¸­ï¼Œè§¦å‘pipeline.fireChannelRead(byteBuf)åï¼Œ

- æœ¬è´¨æ˜¯æ•°æ®åœ¨pipelineä¸­æ‰€æœ‰handlerçš„channelRead()æ‰§è¡Œè¿‡ç¨‹
- Handlerè¦å®ç°ChannelInboundHander#channelReadæ–¹æ³•ï¼Œå¹¶ä¸”ä¸èƒ½åŠ @Skip
- ä¸­é€”å¯é€€å‡ºï¼Œä¸ä¿è¯æ‰§è¡Œåˆ°Tail Handler
- é»˜è®¤å¤„ç†çº¿ç¨‹å°±æ˜¯Channelç»‘å®šçš„NioEventLoopçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å…¶ä»–çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚



### Nettyå‘é€æ•°æ®

å†™æ•°æ®è¦ç‚¹ï¼š

- Netty å†™æ•°æ®ï¼Œå†™ä¸è¿›å»æ—¶ï¼Œä¼šåœæ­¢å†™ï¼Œç„¶åæ³¨å†Œä¸€ä¸ª OP_WRITE äº‹ä»¶ï¼Œæ¥é€šçŸ¥ä»€ä¹ˆæ—¶å€™å¯ä»¥å†™è¿›å»äº†å†å†™ã€‚
- Netty æ‰¹é‡å†™æ•°æ®æ—¶ï¼Œå¦‚æœæƒ³å†™çš„éƒ½å†™è¿›å»äº†ï¼Œæ¥ä¸‹æ¥çš„å°è¯•å†™æ›´å¤šï¼ˆè°ƒæ•´ maxBytesPerGatheringWriteï¼‰ã€‚
- Netty åªè¦æœ‰æ•°æ®è¦å†™ï¼Œä¸”èƒ½å†™çš„å‡ºå»ï¼Œåˆ™ä¸€ç›´å°è¯•ï¼Œç›´åˆ°å†™ä¸å‡ºå»æˆ–è€…æ»¡ 16 æ¬¡ï¼ˆwriteSpinCountï¼‰ã€‚å†™ 16 æ¬¡è¿˜æ²¡æœ‰å†™å®Œï¼Œå°±ç›´ æ¥ schedule ä¸€ä¸ª task æ¥ç»§ç»­å†™ï¼Œè€Œä¸æ˜¯ç”¨æ³¨å†Œå†™äº‹ä»¶æ¥è§¦å‘ï¼Œæ›´ç®€æ´æœ‰åŠ›ã€‚
- Netty å¾…flushæ•°æ®å¤ªå¤šï¼Œè¶…è¿‡ä¸€å®šçš„æ°´ä½çº¿ï¼ˆwriteBufferWaterMark.high()ï¼‰ï¼Œä¼šå°†å¯å†™çš„æ ‡å¿—ä½æ”¹æˆ false ï¼Œè®©åº”ç”¨ç«¯è‡ªå·±åšå†³å®šè¦ä¸è¦å‘é€æ•°æ®äº†ã€‚



Write - å†™æ•°æ®åˆ°buffer:

**ctx.write**ï¼šä»å½“å‰Contextå¼€å§‹

**ctx.channel.write**ï¼šä»TailContextå¼€å§‹æ‰§è¡Œ

**ChannelOutboundBuffer#addMessage**



Flush - å‘é€bufferé‡Œé¢çš„æ•°æ®

**ctx.flush**

**AbstractChannel.AbstractUnsafe#flush**

- å‡†å¤‡æ•°æ®ï¼šChannelOutboundBuffer#addFlush
- å‘é€ï¼šNioSocketChannel#doWrite



### Nettyæ–­å¼€è¿æ¥

ä¸»çº¿ï¼š

- å¤šè·¯å¤ç”¨å™¨ï¼ˆSelectorï¼‰æ¥æ”¶åˆ° OP_READ äº‹ä»¶ 
- å¤„ç† OP_READ äº‹ä»¶ï¼šNioSocketChannel.NioSocketChannelUnsafe.read()
  - æ¥å—æ•°æ®
  - åˆ¤æ–­æ¥å—çš„æ•°æ®å¤§å°æ˜¯å¦ < 0 , å¦‚æœæ˜¯ï¼Œè¯´æ˜æ˜¯å…³é—­ï¼Œå¼€å§‹æ‰§è¡Œå…³é—­ï¼š
    - å…³é—­ channelï¼ˆåŒ…å« cancel å¤šè·¯å¤ç”¨å™¨çš„ keyï¼‰ã€‚
    - æ¸…ç†æ¶ˆæ¯ï¼šæ¸…ç†æ¥æ”¶æ•°æ®çš„byteBufå’Œå†™æ•°æ®çš„outboundBuffer
    - è§¦å‘ fireChannelInactive å’Œ fireChannelUnregistered ã€‚

å…³é—­è¿æ¥æœ¬è´¨ï¼š

- java.nio.channels.spi.AbstractInterruptibleChannel#close
  - java.nio.channels.SelectionKey#cancel



### Nettyå…³é—­æœåŠ¡

å…³é—­æœåŠ¡æœ¬è´¨ï¼š

- å…³é—­æ‰€æœ‰è¿æ¥åŠ Selector ï¼š
  - java.nio.channels.Selector#keys
    - java.nio.channels.spi.AbstractInterruptibleChannel#close
    - java.nio.channels.SelectionKey#cancel
  - selector.close()
- æ‰§è¡Œå­˜å‚¨çš„Tasks/Hooksç›´è‡³è¶…è¿‡æœ€å¤§ä¼˜é›…å…³é—­æ—¶é—´
- å…³é—­æ‰€æœ‰çº¿ç¨‹ï¼šé€€å‡ºå¾ªç¯ä½“ for (;;)